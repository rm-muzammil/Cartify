
generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}


/////////////////////
//// USERS & AUTH ///
/////////////////////

model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  password  String
  role      Role     @default(USER)
  createdAt DateTime @default(now())

  stores        Store[]
  teamMembers  TeamMember[]
  auditLogs    AuditLog[]
  subscription Subscription?
}

enum Role {
  ADMIN
  USER
}

///////////////////
//// SAAS CORE ////
///////////////////

model Store {
  id        String   @id @default(uuid())
  name      String
  ownerId  String
  stripeAccountId   String?   // <-- NEW: Stripe Connect Account ID
  stripeOnboarded   Boolean   @default(false)
  createdAt DateTime @default(now())

  commissionRate Float @default(10)


  owner   User @relation(fields: [ownerId], references: [id])

  customers Customer[]
  products Product[]
  orders   Order[]
  members  TeamMember[]
  events   AnalyticsEvent[]
}

model Subscription {
  id          String @id @default(uuid())
  userId      String @unique
  plan        Plan
  status      String
  stripeSubId String?
  startedAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

enum Plan {
  free
  pro
  team
}

///////////////////
//// TEAM ////////
///////////////////

model TeamMember {
  id      String @id @default(uuid())
  userId  String
  storeId String
  role    TeamRole

  user  User  @relation(fields: [userId], references: [id])
  store Store @relation(fields: [storeId], references: [id])

  @@unique([userId, storeId])
}

enum TeamRole {
  OWNER
  ADMIN
  MEMBER
}

///////////////////
//// ECOMMERCE ////
///////////////////

model Product {
  @@index([storeId])

  id          String   @id @default(uuid())
  storeId     String
  name        String
  description String?
  price       Float
  stock       Int
  images      String[]
  status      ProductStatus @default(ACTIVE)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  store  Store @relation(fields: [storeId], references: [id])
  items  OrderItem[]
}

enum ProductStatus {
  ACTIVE
  DRAFT
  ARCHIVED
}


model Order {
  @@index([storeId, createdAt])

  id        String   @id @default(uuid())
  storeId   String
  customerId String
  total     Float
  status    OrderStatus
  stripePaymentIntentId String?
  createdAt DateTime @default(now())

  platformFee Float?

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  items OrderItem[]
  payment Payment?
  customer Customer @relation(fields: [customerId],references: [id])
  
  @@index([storeId])
  @@index([customerId])

}

model OrderItem {
  id        String @id @default(uuid())
  orderId  String
  productId String
  quantity Int
  price    Float
  

  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])
}

enum OrderStatus {
  pending
  checkout
  paid
  shipped
  canceled
  refunded
  failed
}

model Payment {
  id        String @id @default(uuid())
  orderId  String @unique
  provider String
  amount   Float
  status   String
  createdAt DateTime @default(now())

  order Order @relation(fields: [orderId], references: [id])
}

///////////////////
//// ANALYTICS ///
///////////////////

model AnalyticsEvent {
  @@index([storeId, createdAt])
  
  id        String @id @default(uuid())
  storeId   String
  type      String   // page_view, purchase, signup, etc
  value     Float?
  createdAt DateTime @default(now())

  store Store @relation(fields: [storeId], references: [id])
}

///////////////////
//// AUDIT LOG ///
///////////////////

model AuditLog {
  id        String @id @default(uuid())
  userId   String?
  action   String
  entity   String?
  entityId String?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])
}

model Customer {
  id        String   @id @default(uuid())
  storeId   String
  name      String
  email     String?
  password  String?
  createdAt DateTime @default(now())

  store  Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)
  orders Order[]

  @@unique([email, storeId])
}
